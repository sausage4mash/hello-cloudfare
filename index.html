<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; 
        }

        /* Markdown Content Styling within Chat Bubbles */
        .prose p { margin-bottom: 0.5rem; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose pre { 
            background-color: #1e293b; 
            padding: 0.75rem; 
            border-radius: 0.375rem; 
            overflow-x: auto; 
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .prose code { 
            background-color: rgba(0,0,0,0.2); 
            padding: 0.1rem 0.3rem; 
            border-radius: 0.25rem; 
            font-family: monospace;
            font-size: 0.9em;
        }
        .prose pre code {
            background-color: transparent;
            padding: 0;
        }
        .prose strong { font-weight: 700; color: inherit; }
        .prose a { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex-none h-16 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md flex items-center justify-between px-4 sm:px-6 z-10">
        <div class="flex items-center gap-4">
            <!-- AI Eyes Container -->
            <div class="relative w-16 h-10 bg-black/50 rounded-lg border border-blue-900/30 flex items-center justify-center overflow-hidden shadow-[0_0_10px_rgba(59,130,246,0.1)]">
                <canvas id="eye-canvas" width="64" height="40" class="w-full h-full"></canvas>
            </div>
            
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Gemini Assistant</h1>
                <p class="text-xs text-gray-400 font-medium flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Online
                </p>
            </div>
        </div>
    </header>

    <!-- Chat Messages Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 scroll-smooth space-y-6">
        <!-- Welcome Message -->
        <div class="flex gap-4 max-w-3xl mx-auto">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-600/20 border border-indigo-500/30 flex items-center justify-center">
                <i data-lucide="bot" class="w-5 h-5 text-indigo-400"></i>
            </div>
            <div class="flex-1 space-y-2">
                <div class="flex items-baseline gap-2">
                    <span class="font-semibold text-sm text-gray-200">Gemini</span>
                    <span class="text-xs text-gray-500">Just now</span>
                </div>
                <div class="prose text-gray-300 text-sm leading-relaxed bg-gray-900 border border-gray-800 rounded-2xl rounded-tl-none px-5 py-3 shadow-sm w-fit">
                    <p>Hello! I am your AI assistant. I can see you moving your cursor! How can I help?</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="flex-none p-4 sm:p-6 bg-gray-950 border-t border-gray-800">
        <div class="max-w-3xl mx-auto relative">
            <form id="chat-form" class="relative flex items-end gap-2 bg-gray-900 border border-gray-800 rounded-2xl p-2 shadow-lg focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500 transition-all">
                
                <textarea 
                    id="user-input" 
                    rows="1"
                    placeholder="Type your message..." 
                    class="w-full bg-transparent text-gray-100 placeholder-gray-500 text-sm px-4 py-3 focus:outline-none resize-none max-h-32 overflow-y-auto scrollbar-hide"
                    required
                ></textarea>

                <button 
                    type="submit" 
                    id="send-btn"
                    class="flex-none p-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </form>
            <div class="text-center mt-2">
                 <p class="text-[10px] text-gray-600">AI can make mistakes. Check important info.</p>
            </div>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        // Initialize Icons
        lucide.createIcons();

        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Worker Configuration
        const WORKER_URL = "https://solitary-art-922c.robertjohncollins.workers.dev/";

        // State
        let isGenerating = false;
        let chatHistory = []; // Stores { role: 'user' | 'model', text: string }

        // --- Eye Animation Logic ---
        class EyeController {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                this.ctx = this.canvas.getContext('2d');
                
                // Eye State
                this.eyeX = 0;
                this.eyeY = 0;
                this.blinkScale = 1;
                this.isThinking = false;
                this.thinkingPhase = 0;
                
                // Mouse Tracking Targets
                this.targetX = 0;
                this.targetY = 0;
                
                // Bind Events
                window.addEventListener('mousemove', this.handleMouseMove.bind(this));
                window.addEventListener('resize', this.handleResize.bind(this));
                
                // Start Loops
                this.rect = this.canvas.getBoundingClientRect();
                this.startBlinkLoop();
                this.animate();
            }
            
            handleResize() {
                this.rect = this.canvas.getBoundingClientRect();
            }

            handleMouseMove(e) {
                // Recalculate rect occasionally in case of scroll/layout change
                this.rect = this.canvas.getBoundingClientRect();
                
                const centerX = this.rect.left + this.rect.width / 2;
                const centerY = this.rect.top + this.rect.height / 2;
                
                const maxOffset = 8; // Max pixels eyes move from center
                const dx = e.clientX - centerX;
                const dy = e.clientY - centerY;
                
                // Calculate angle and distance
                const angle = Math.atan2(dy, dx);
                // Dampen distance so eyes don't go crazy
                const distance = Math.min(Math.sqrt(dx*dx + dy*dy), 500); 
                const scale = distance / 500; 
                
                this.targetX = Math.cos(angle) * maxOffset * scale;
                this.targetY = Math.sin(angle) * maxOffset * scale;
            }

            setThinking(thinking) {
                this.isThinking = thinking;
            }

            startBlinkLoop() {
                const blink = () => {
                    if (this.isThinking) {
                        setTimeout(blink, 1000); 
                        return;
                    }

                    let startTime = Date.now();
                    const duration = 150;
                    
                    const animateBlink = () => {
                        const elapsed = Date.now() - startTime;
                        if (elapsed < duration) {
                            // Sine wave for smooth 1 -> 0.1 -> 1
                            const progress = elapsed / duration;
                            const deviation = Math.sin(progress * Math.PI);
                            this.blinkScale = 1 - (deviation * 0.95);
                            requestAnimationFrame(animateBlink);
                        } else {
                            this.blinkScale = 1;
                        }
                    };
                    animateBlink();
                    
                    // Random blink interval between 2s and 6s
                    setTimeout(blink, Math.random() * 4000 + 2000);
                };
                setTimeout(blink, 2000);
            }

            drawEye(x, y, width, height) {
                const h = height * this.blinkScale;
                
                // Glow Effect
                this.ctx.shadowBlur = 15;
                this.ctx.shadowColor = '#3b82f6'; // Tailwind blue-500
                this.ctx.fillStyle = '#60a5fa';   // Tailwind blue-400
                
                this.ctx.beginPath();
                if (this.ctx.roundRect) {
                    this.ctx.roundRect(x - width/2, y - h/2, width, h, width/2);
                } else {
                    // Fallback for older browsers
                    this.ctx.ellipse(x, y, width/2, h/2, 0, 0, Math.PI * 2);
                }
                this.ctx.fill();
                
                // Reset Shadow for performance/cleanliness if needed
                this.ctx.shadowBlur = 0;
            }

            animate() {
                this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                
                if (this.isThinking) {
                    // Thinking Animation: Squint and Vibrate
                    this.thinkingPhase += 0.2;
                    this.blinkScale = 0.6 + Math.sin(this.thinkingPhase) * 0.1; // Squint
                    
                    // Vibrate
                    this.eyeX = (Math.random() - 0.5) * 2;
                    this.eyeY = (Math.random() - 0.5) * 2;
                } else {
                    // Smooth Look Tracking (Linear Interpolation)
                    this.eyeX += (this.targetX - this.eyeX) * 0.15;
                    this.eyeY += (this.targetY - this.eyeY) * 0.15;
                }

                // Draw Eyes
                const centerX = this.canvas.width / 2;
                const centerY = this.canvas.height / 2;
                const eyeSpacing = 16;
                const eyeWidth = 10;
                const eyeHeight = 22;

                this.drawEye(centerX - eyeSpacing + this.eyeX, centerY + this.eyeY, eyeWidth, eyeHeight);
                this.drawEye(centerX + eyeSpacing + this.eyeX, centerY + this.eyeY, eyeWidth, eyeHeight);

                requestAnimationFrame(() => this.animate());
            }
        }

        // Init Eyes
        const eyes = new EyeController('eye-canvas');

        // --- End Eye Animation Logic ---

        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Handle Enter key (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isGenerating && userInput.value.trim()) {
                    chatForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        // Scroll to bottom helper
        const scrollToBottom = () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Create Message HTML
        const createMessageHTML = (role, content, isThinking = false) => {
            const isUser = role === 'user';
            const iconName = isUser ? 'user' : 'bot';
            const iconBg = isUser ? 'bg-blue-600' : 'bg-indigo-600/20 border border-indigo-500/30';
            const iconColor = isUser ? 'text-white' : 'text-indigo-400';
            const name = isUser ? 'You' : 'Gemini';
            
            // Bubble Styles
            const bubbleClass = isUser 
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none' 
                : 'bg-gray-900 border border-gray-800 text-gray-300 rounded-2xl rounded-tl-none';

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Parse Markdown if bot, plain text if user
            let parsedContent = content;
            if (!isUser && !isThinking) {
                parsedContent = marked.parse(content);
            }

            return `
                <div class="flex gap-4 max-w-3xl mx-auto ${isUser ? 'flex-row-reverse' : ''} group fade-in">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${iconBg} flex items-center justify-center">
                        <i data-lucide="${iconName}" class="w-5 h-5 ${iconColor}"></i>
                    </div>
                    <div class="flex-1 space-y-2 ${isUser ? 'flex flex-col items-end' : ''}">
                        <div class="flex items-baseline gap-2 ${isUser ? 'flex-row-reverse' : ''}">
                            <span class="font-semibold text-sm text-gray-200">${name}</span>
                            <span class="text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">${timestamp}</span>
                        </div>
                        <div class="prose text-sm leading-relaxed px-5 py-3 shadow-sm w-fit ${bubbleClass}">
                            ${isThinking 
                                ? '<div class="flex space-x-1 h-5 items-center"><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div></div>' 
                                : (isUser ? `<p>${content}</p>` : parsedContent)
                            }
                        </div>
                    </div>
                </div>
            `;
        };

        // Add Message to UI
        const appendMessage = (role, content, isThinking = false) => {
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = createMessageHTML(role, content, isThinking);
            
            if (isThinking) {
                msgDiv.id = 'thinking-bubble';
            }
            
            chatContainer.appendChild(msgDiv);
            lucide.createIcons();
            scrollToBottom();
        };

        // Remove Thinking Bubble
        const removeThinking = () => {
            const thinking = document.getElementById('thinking-bubble');
            if (thinking) {
                thinking.remove();
            }
        };

        // Handle Form Submit
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            
            if (!text || isGenerating) return;

            // 1. UI: Set State
            isGenerating = true;
            eyes.setThinking(true); // EYES THINKING
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 2. UI: Add User Message
            appendMessage('user', text);

            // 3. DATA: Update History with User Message
            chatHistory.push({ role: 'user', text: text });

            // 4. UI: Add Thinking Indicator
            appendMessage('model', '', true);

            try {
                // 5. DATA: Prepare Prompt with History
                const promptWithHistory = chatHistory
                    .slice(-20)
                    .map(msg => `${msg.role === 'user' ? 'User' : 'Gemini'}: ${msg.text}`)
                    .join('\n');

                // 6. API: Call Worker
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: promptWithHistory })
                });

                if (!response.ok) throw new Error('Worker responded with error');

                const data = await response.json();
                const replyText = data.reply || "No response received.";
                
                // 7. UI: Update with Real Response
                removeThinking();
                appendMessage('model', replyText);

                // 8. DATA: Update History with Model Response
                chatHistory.push({ role: 'model', text: replyText });

            } catch (error) {
                console.error('Error:', error);
                removeThinking();
                appendMessage('model', "**Error:** Could not connect to the AI service. Please try again.");
            } finally {
                // 9. Reset UI State
                isGenerating = false;
                eyes.setThinking(false); // EYES NORMAL
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        });

        // Initial Icon Render
        lucide.createIcons();
    </script>
</body>
</html>
