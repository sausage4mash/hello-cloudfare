<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Chat</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tailwind Config for Custom Colors/Fonts -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        gray: {
                            850: '#1f2937',
                            900: '#111827',
                            950: '#030712',
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <!-- Marked.js for Markdown Parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #111827; 
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; 
        }

        /* Markdown Content Styling within Chat Bubbles */
        .prose p { margin-bottom: 0.5rem; }
        .prose p:last-child { margin-bottom: 0; }
        .prose ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose ol { list-style-type: decimal; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .prose pre { 
            background-color: #1e293b; 
            padding: 0.75rem; 
            border-radius: 0.375rem; 
            overflow-x: auto; 
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-family: monospace;
            font-size: 0.9em;
        }
        .prose code { 
            background-color: rgba(0,0,0,0.2); 
            padding: 0.1rem 0.3rem; 
            border-radius: 0.25rem; 
            font-family: monospace;
            font-size: 0.9em;
        }
        .prose pre code {
            background-color: transparent;
            padding: 0;
        }
        .prose strong { font-weight: 700; color: inherit; }
        .prose a { color: #60a5fa; text-decoration: underline; }
    </style>
</head>
<body class="bg-gray-950 text-gray-100 font-sans antialiased h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="flex-none h-16 border-b border-gray-800 bg-gray-900/50 backdrop-blur-md flex items-center justify-between px-4 sm:px-6 z-10">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 rounded-xl bg-gradient-to-tr from-blue-600 to-indigo-500 flex items-center justify-center shadow-lg shadow-blue-900/20">
                <i data-lucide="sparkles" class="text-white w-6 h-6"></i>
            </div>
            <div>
                <h1 class="font-bold text-lg tracking-tight text-white">Gemini Assistant</h1>
                <p class="text-xs text-gray-400 font-medium flex items-center gap-1.5">
                    <span class="relative flex h-2 w-2">
                      <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                      <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Online
                </p>
            </div>
        </div>
    </header>

    <!-- Chat Messages Container -->
    <main id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 scroll-smooth space-y-6">
        <!-- Welcome Message -->
        <div class="flex gap-4 max-w-3xl mx-auto">
            <div class="flex-shrink-0 w-8 h-8 rounded-full bg-indigo-600/20 border border-indigo-500/30 flex items-center justify-center">
                <i data-lucide="bot" class="w-5 h-5 text-indigo-400"></i>
            </div>
            <div class="flex-1 space-y-2">
                <div class="flex items-baseline gap-2">
                    <span class="font-semibold text-sm text-gray-200">Gemini</span>
                    <span class="text-xs text-gray-500">Just now</span>
                </div>
                <div class="prose text-gray-300 text-sm leading-relaxed bg-gray-900 border border-gray-800 rounded-2xl rounded-tl-none px-5 py-3 shadow-sm w-fit">
                    <p>Hello! I am your AI assistant. How can I help you today?</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Input Area -->
    <footer class="flex-none p-4 sm:p-6 bg-gray-950 border-t border-gray-800">
        <div class="max-w-3xl mx-auto relative">
            <form id="chat-form" class="relative flex items-end gap-2 bg-gray-900 border border-gray-800 rounded-2xl p-2 shadow-lg focus-within:ring-2 focus-within:ring-blue-500/50 focus-within:border-blue-500 transition-all">
                
                <textarea 
                    id="user-input" 
                    rows="1"
                    placeholder="Type your message..." 
                    class="w-full bg-transparent text-gray-100 placeholder-gray-500 text-sm px-4 py-3 focus:outline-none resize-none max-h-32 overflow-y-auto scrollbar-hide"
                    required
                ></textarea>

                <button 
                    type="submit" 
                    id="send-btn"
                    class="flex-none p-2.5 rounded-xl bg-blue-600 hover:bg-blue-500 text-white disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
                >
                    <i data-lucide="send" class="w-5 h-5"></i>
                </button>
            </form>
            <div class="text-center mt-2">
                 <p class="text-[10px] text-gray-600">AI can make mistakes. Check important info.</p>
            </div>
        </div>
    </footer>

    <!-- Application Logic -->
    <script>
        // Initialize Icons
        lucide.createIcons();

        // DOM Elements
        const chatContainer = document.getElementById('chat-container');
        const chatForm = document.getElementById('chat-form');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        
        // Worker Configuration
        const WORKER_URL = "https://solitary-art-922c.robertjohncollins.workers.dev/";

        // State
        let isGenerating = false;

        // Auto-resize textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
            if(this.value === '') this.style.height = 'auto';
        });

        // Handle Enter key (Shift+Enter for new line)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                if (!isGenerating && userInput.value.trim()) {
                    chatForm.dispatchEvent(new Event('submit'));
                }
            }
        });

        // Scroll to bottom helper
        const scrollToBottom = () => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };

        // Create Message HTML
        const createMessageHTML = (role, content, isThinking = false) => {
            const isUser = role === 'user';
            const iconName = isUser ? 'user' : 'bot';
            const iconBg = isUser ? 'bg-blue-600' : 'bg-indigo-600/20 border border-indigo-500/30';
            const iconColor = isUser ? 'text-white' : 'text-indigo-400';
            const name = isUser ? 'You' : 'Gemini';
            
            // Bubble Styles
            const bubbleClass = isUser 
                ? 'bg-blue-600 text-white rounded-2xl rounded-tr-none' 
                : 'bg-gray-900 border border-gray-800 text-gray-300 rounded-2xl rounded-tl-none';

            const timestamp = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            // Parse Markdown if bot, plain text if user
            let parsedContent = content;
            if (!isUser && !isThinking) {
                parsedContent = marked.parse(content);
            }

            return `
                <div class="flex gap-4 max-w-3xl mx-auto ${isUser ? 'flex-row-reverse' : ''} group fade-in">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full ${iconBg} flex items-center justify-center">
                        <i data-lucide="${iconName}" class="w-5 h-5 ${iconColor}"></i>
                    </div>
                    <div class="flex-1 space-y-2 ${isUser ? 'flex flex-col items-end' : ''}">
                        <div class="flex items-baseline gap-2 ${isUser ? 'flex-row-reverse' : ''}">
                            <span class="font-semibold text-sm text-gray-200">${name}</span>
                            <span class="text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity">${timestamp}</span>
                        </div>
                        <div class="prose text-sm leading-relaxed px-5 py-3 shadow-sm w-fit ${bubbleClass}">
                            ${isThinking 
                                ? '<div class="flex space-x-1 h-5 items-center"><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 0ms"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 150ms"></div><div class="w-2 h-2 bg-indigo-400 rounded-full animate-bounce" style="animation-delay: 300ms"></div></div>' 
                                : (isUser ? `<p>${content}</p>` : parsedContent)
                            }
                        </div>
                    </div>
                </div>
            `;
        };

        // Add Message to UI
        const appendMessage = (role, content, isThinking = false) => {
            const msgDiv = document.createElement('div');
            msgDiv.innerHTML = createMessageHTML(role, content, isThinking);
            
            if (isThinking) {
                msgDiv.id = 'thinking-bubble';
            }
            
            chatContainer.appendChild(msgDiv);
            lucide.createIcons();
            scrollToBottom();
        };

        // Remove Thinking Bubble
        const removeThinking = () => {
            const thinking = document.getElementById('thinking-bubble');
            if (thinking) {
                thinking.remove();
            }
        };

        // Handle Form Submit
        chatForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = userInput.value.trim();
            
            if (!text || isGenerating) return;

            // 1. UI: Set State
            isGenerating = true;
            userInput.value = '';
            userInput.style.height = 'auto';
            userInput.disabled = true;
            sendBtn.disabled = true;

            // 2. UI: Add User Message
            appendMessage('user', text);

            // 3. UI: Add Thinking Indicator
            appendMessage('model', '', true);

            try {
                // 4. API: Call Worker
                const response = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: text })
                });

                if (!response.ok) throw new Error('Worker responded with error');

                const data = await response.json();
                
                // 5. UI: Update with Real Response
                removeThinking();
                appendMessage('model', data.reply || "No response received.");

            } catch (error) {
                console.error('Error:', error);
                removeThinking();
                appendMessage('model', "**Error:** Could not connect to the AI service. Please try again.");
            } finally {
                // 6. Reset UI State
                isGenerating = false;
                userInput.disabled = false;
                sendBtn.disabled = false;
                userInput.focus();
            }
        });

        // Initial Icon Render
        lucide.createIcons();
    </script>
</body>
</html>
